#include "rvv_inst_counter.h"

// Algorithm:
// 0. autogenerate opcode array and masks from rvv-opcodes/opcodes-rvv file
// 1. loop over opcodes to find a match (upgrade loop to a map later).
// 2. when a match is detected, update that index's count
// 3. break the loop (assume one match max per instruction)

const uint32_t rvv_opcode_array[NUM_RVV_OPCODES] = {
    0xc0007057, 0x00007057, 0x80007057, 0x02b00007, 0x02b00027, 0x00000007,
    0x00005007, 0x00006007, 0x00007007, 0x10000007, 0x10005007, 0x10006007,
    0x10007007, 0x00000027, 0x00005027, 0x00006027, 0x00007027, 0x10000027,
    0x10005027, 0x10006027, 0x10007027, 0x04000007, 0x04005007, 0x04006007,
    0x04007007, 0x14000007, 0x14005007, 0x14006007, 0x14007007, 0x04000027,
    0x04005027, 0x04006027, 0x04007027, 0x14000027, 0x14005027, 0x14006027,
    0x14007027, 0x08000007, 0x08005007, 0x08006007, 0x08007007, 0x18000007,
    0x18005007, 0x18006007, 0x18007007, 0x08000027, 0x08005027, 0x08006027,
    0x08007027, 0x18000027, 0x18005027, 0x18006027, 0x18007027, 0x0c000007,
    0x0c005007, 0x0c006007, 0x0c007007, 0x1c000007, 0x1c005007, 0x1c006007,
    0x1c007007, 0x0c000027, 0x0c005027, 0x0c006027, 0x0c007027, 0x1c000027,
    0x1c005027, 0x1c006027, 0x1c007027, 0x01000007, 0x01005007, 0x01006007,
    0x01007007, 0x11000007, 0x11005007, 0x11006007, 0x11007007, 0x02800007,
    0x02805007, 0x02806007, 0x02807007, 0x22800007, 0x22805007, 0x22806007,
    0x22807007, 0x62800007, 0x62805007, 0x62806007, 0x62807007, 0xe2800007,
    0xe2805007, 0xe2806007, 0xe2807007, 0x02800027, 0x22800027, 0x62800027,
    0xe2800027, 0x00005057, 0x08005057, 0x10005057, 0x18005057, 0x20005057,
    0x24005057, 0x28005057, 0x38005057, 0x3c005057, 0x42005057, 0x5c005057,
    0x5e005057, 0x60005057, 0x64005057, 0x6c005057, 0x70005057, 0x74005057,
    0x7c005057, 0x80005057, 0x84005057, 0x90005057, 0x9c005057, 0xa0005057,
    0xa4005057, 0xa8005057, 0xac005057, 0xb0005057, 0xb4005057, 0xb8005057,
    0xbc005057, 0xc0005057, 0xc8005057, 0xd0005057, 0xd8005057, 0xe0005057,
    0xf0005057, 0xf4005057, 0xf8005057, 0xfc005057, 0x00001057, 0x04001057,
    0x08001057, 0x0c001057, 0x10001057, 0x14001057, 0x18001057, 0x1c001057,
    0x20001057, 0x24001057, 0x28001057, 0x42001057, 0x60001057, 0x64001057,
    0x6c001057, 0x70001057, 0x80001057, 0x90001057, 0xa0001057, 0xa4001057,
    0xa8001057, 0xac001057, 0xb0001057, 0xb4001057, 0xb8001057, 0xbc001057,
    0x48001057, 0x48009057, 0x48011057, 0x48019057, 0x48031057, 0x48039057,
    0x48041057, 0x48049057, 0x48051057, 0x48059057, 0x48061057, 0x48071057,
    0x48079057, 0x48081057, 0x48089057, 0x48091057, 0x48099057, 0x480a1057,
    0x480a9057, 0x480b1057, 0x480b9057, 0x4c001057, 0x4c021057, 0x4c029057,
    0x4c081057, 0xc0001057, 0xc4001057, 0xc8001057, 0xcc001057, 0xd0001057,
    0xd8001057, 0xe0001057, 0xf0001057, 0xf4001057, 0xf8001057, 0xfc001057,
    0x00004057, 0x08004057, 0x0c004057, 0x10004057, 0x14004057, 0x18004057,
    0x1c004057, 0x24004057, 0x28004057, 0x2c004057, 0x30004057, 0x38004057,
    0x3c004057, 0x40004057, 0x44004057, 0x46004057, 0x48004057, 0x4c004057,
    0x4e004057, 0x5c004057, 0x5e004057, 0x60004057, 0x64004057, 0x68004057,
    0x6c004057, 0x70004057, 0x74004057, 0x78004057, 0x7c004057, 0x80004057,
    0x84004057, 0x88004057, 0x8c004057, 0x94004057, 0x9c004057, 0xa0004057,
    0xa4004057, 0xa8004057, 0xac004057, 0xb0004057, 0xb4004057, 0xb8004057,
    0xbc004057, 0x00000057, 0x08000057, 0x10000057, 0x14000057, 0x18000057,
    0x1c000057, 0x24000057, 0x28000057, 0x2c000057, 0x30000057, 0x38000057,
    0x40000057, 0x44000057, 0x46000057, 0x48000057, 0x4c000057, 0x4e000057,
    0x5c000057, 0x5e000057, 0x60000057, 0x64000057, 0x68000057, 0x6c000057,
    0x70000057, 0x74000057, 0x80000057, 0x84000057, 0x88000057, 0x8c000057,
    0x94000057, 0x9c000057, 0xa0000057, 0xa4000057, 0xa8000057, 0xac000057,
    0xb0000057, 0xb4000057, 0xb8000057, 0xbc000057, 0xc0000057, 0xc4000057,
    0x00003057, 0x0c003057, 0x24003057, 0x28003057, 0x2c003057, 0x30003057,
    0x38003057, 0x3c003057, 0x40003057, 0x44003057, 0x46003057, 0x5c003057,
    0x5e003057, 0x60003057, 0x64003057, 0x70003057, 0x74003057, 0x78003057,
    0x7c003057, 0x80003057, 0x84003057, 0x94003057, 0x9e003057, 0x9e00b057,
    0x9e01b057, 0x9e03b057, 0xa0003057, 0xa4003057, 0xa8003057, 0xac003057,
    0xb0003057, 0xb4003057, 0xb8003057, 0xbc003057, 0x00002057, 0x04002057,
    0x08002057, 0x0c002057, 0x10002057, 0x14002057, 0x18002057, 0x1c002057,
    0x20002057, 0x24002057, 0x28002057, 0x2c002057, 0x42002057, 0x48012057,
    0x4801a057, 0x48022057, 0x4802a057, 0x48032057, 0x4803a057, 0x5e002057,
    0x60002057, 0x64002057, 0x68002057, 0x6c002057, 0x70002057, 0x74002057,
    0x78002057, 0x7c002057, 0x5000a057, 0x50012057, 0x5001a057, 0x50082057,
    0x5008a057, 0x40082057, 0x4008a057, 0x80002057, 0x84002057, 0x88002057,
    0x8c002057, 0x90002057, 0x94002057, 0x98002057, 0x9c002057, 0xa4002057,
    0xac002057, 0xb4002057, 0xbc002057, 0xc0002057, 0xc4002057, 0xc8002057,
    0xcc002057, 0xd0002057, 0xd4002057, 0xd8002057, 0xdc002057, 0xe0002057,
    0xe8002057, 0xec002057, 0xf0002057, 0xf4002057, 0xfc002057, 0x20006057,
    0x24006057, 0x28006057, 0x2c006057, 0x42006057, 0x38006057, 0x3c006057,
    0x80006057, 0x84006057, 0x88006057, 0x8c006057, 0x90006057, 0x94006057,
    0x98006057, 0x9c006057, 0xa4006057, 0xac006057, 0xb4006057, 0xbc006057,
    0xc0006057, 0xc4006057, 0xc8006057, 0xcc006057, 0xd0006057, 0xd4006057,
    0xd8006057, 0xdc006057, 0xe0006057, 0xe8006057, 0xec006057, 0xf0006057,
    0xf4006057, 0xf8006057, 0xfc006057, 0x0800002f, 0x0000002f, 0x2000002f,
    0x6000002f, 0x4000002f, 0x8000002f, 0xa000002f, 0xc000002f, 0xe000002f,
    0x0800502f, 0x0000502f, 0x2000502f, 0x6000502f, 0x4000502f, 0x8000502f,
    0xa000502f, 0xc000502f, 0xe000502f, 0x0800602f, 0x0000602f, 0x2000602f,
    0x6000602f, 0x4000602f, 0x8000602f, 0xa000602f, 0xc000602f, 0xe000602f,
    0x0800702f, 0x0000702f, 0x2000702f, 0x6000702f, 0x4000702f, 0x8000702f,
    0xa000702f, 0xc000702f, 0xe000702f};

const uint32_t rvv_mask_array[NUM_RVV_OPCODES] = {
    0xc000707f, 0x8000707f, 0xfe00707f, 0xfff0707f, 0xfff0707f, 0x1df0707f,
    0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f,
    0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f,
    0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1c00707f,
    0x1c00707f, 0x1c00707f, 0x1c00707f, 0x1df0707f, 0x1df0707f, 0x1df0707f,
    0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f, 0x1df0707f, 0xfff0707f,
    0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f,
    0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f,
    0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f, 0xfff0707f,
    0xfff0707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfff0707f, 0xfe00707f,
    0xfff0707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfe0ff07f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f,
    0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f,
    0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f,
    0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f,
    0xfc0ff07f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f,
    0xfe00707f, 0xfe00707f, 0xfff0707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfe00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f,
    0xfe00707f, 0xfff0707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f, 0xfe00707f,
    0xfff0707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfe0ff07f, 0xfe0ff07f,
    0xfe0ff07f, 0xfe0ff07f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfe0ff07f, 0xfc0ff07f,
    0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfe00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc0ff07f,
    0xfdfff07f, 0xfc0ff07f, 0xfc0ff07f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfff0707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f, 0xfc00707f,
    0xfc00707f, 0xfc00707f, 0xfc00707f, 0xf800707f, 0xf800707f, 0xf800707f,
    0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f,
    0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f,
    0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f,
    0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f,
    0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f, 0xf800707f,
    0xf800707f, 0xf800707f, 0xf800707f};

void rvv_opcode_sieve(CPUState *env, uint32_t full_opcode, uint32_t op, uint32_t rm) {
  switch (op) {
    case OPC_RISC_FP_LOAD:
      if (rm > 4) {
        return rvv_opcode_counter(env, full_opcode);
      }
      break;
    case OPC_RISC_FP_STORE:
      if (rm > 4) {
        return rvv_opcode_counter(env, full_opcode);
      }
      break;
    case OPC_RISC_V:
      return rvv_opcode_counter(env, full_opcode);
      break;
    default:
      break;
  }
}

void rvv_opcode_counter(CPUState *env, uint32_t opcode) {
  uint32_t masked_opcode;
  for (int i = 0; i < NUM_RVV_OPCODES; i++) {
    // mask out non-opcode fields
    masked_opcode = opcode & rvv_mask_array[i];
    if (rvv_opcode_array[i] == masked_opcode) {
      env->rvv_opcode_count[i] += 1;
      break;
    }
  }
}
